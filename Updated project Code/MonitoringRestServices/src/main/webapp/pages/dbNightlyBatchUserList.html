<script>
	var mTime = null;
	function updateTime() {
		mTime = Date.now().toString();
	}
	function destroyDataTable(id) {
		var table = $('#' + id).DataTable();
		console.log("tablee+" + table + "$('#'+id)::" + id);
		if (table != null) {
			table.destroy();
			console.log("Data table destroyed");
		}
	}

	$(document).ready(function() {
		getNBUSerEventList();
	});

	function getNBUSerEventList() {
		$("#nbEventsDates").attr("style", "margin: -4% 0 1%;");
		$("#fetchNBUserEvents").attr("style", "margin: 8% 0 0;");
		updateTime();
		var d = new Date();
		var month = d.getMonth() + 1;
		var day = d.getDate();

		var today = (('' + day).length < 2 ? '0' : '') + day + '/'
				+ (('' + month).length < 2 ? '0' : '') + month + '/'
				+ d.getFullYear();
		$("#txtFromDate").val("");
		$("#txtToDate").val("");
		destroyDataTable('fetchNBUserEventsData');
		var loggedUserData = {};
		loggedUserData.id = loggedUserID;
		loggedUserData.flag = loggedUserFlag;
		console.log("loggedUserData" + JSON.stringify(loggedUserData));
		$
				.ajax({
					type : "GET",
					contentType : "application/json; charset=utf-8",
					url : "/MonitoringRestServices/rest/nightlyBatchEvents/"
							+ loggedUserID + "?startDate=" + today
							+ "&endDate=" + today + "&mtime=" + mTime,
					dataType : "json",
					headers : getHeadersData(),
					success : function(responseData) {
						$("#nbEventsDates").show();
						console.log("Nightly Batch Events Success.. ");
						$("#fetchNBUserEventsData tbody").html("");
						$("#fetchNBUserEventsData").show();
						if (responseData.length > 0) {
							$(".my-legend").show();
							$("#nbUserEvenetResults").html("");
							$("#nbUserEvenetResults").removeClass(
									"alert alert-danger");
							$("#nbEventsDates").attr("style",
									"margin: 0% 0 -3%;");
							$("#fetchNBUserEvents").attr("style",
									"margin: 4% 0 0;");
							var nbErrorColor = null;
							var nbErrorTxtColor = 'white';
							$.each(responseData,function(i, item) {
												if (item.errorLevel == 4) {
													nbErrorColor = 'red';
												} else if (item.errorLevel == 3) {
													nbErrorColor = 'Orange';
												} else if (item.errorLevel == 1) {
													nbErrorColor = 'green';
												} else if (item.errorLevel == 0) {
													nbErrorColor = 'green';
												}
												
												$("#fetchNBUserEventsData tbody")
														.append(
																'<tr style="background:'+nbErrorColor+';color:'+nbErrorTxtColor+'"><td class="nbErrorMessage">'
																		+ item.errorMessage
																		+ '</td>'
																		+ '<td class="nbEParameters" style="display:none;">'
																		+ item.parameters
																		+ '</td>'
																		+ '<td id="nbEventDescription">'
																		+ item.description
																		+ '</td>'
																		+ '<td id="nbEIDate">'
																		+ item.insertedDate
																		+ '</td>'
																		+ '<td id="nbEventHost">'
																		+ item.host
																		+ '</td>'
																		+'<td id="nbEroorLevel">'
																		+ item.errorLevel
																		+ '</td></tr>');
											});
							$.fn.dataTableExt.sErrMode = 'throw';
							$('#fetchNBUserEventsData').DataTable({
								"searching" : true,
								"destroy" : true,
								"language" : {
									search : "_INPUT_",
									searchPlaceholder : "Search..."
								},
								"pagingType" : "simple",
								"bLengthChange" : false,
								"bSort" : true
							});
						} else {
							
							$("#nbEventsDates").attr("style",
									"margin: -4% 0 1%;");
							$("#fetchNBUserEvents").attr("style",
									"margin: 8% 0 0;");
							$("#nbUserEvenetResults")
									.html(
											'<p class="failureMessage">No Events are avaialble</p>');
							$("#nbUserEvenetResults").addClass(
									"alert alert-danger");
						}
						$('input, search').placeholder();

					},
					failure : function(errMsg) {
						
						$("#nbEventsDates").hide();
						$("#fetchNBUserEvents")
								.attr("style", "margin: 8% 0 0;");
						$("#nbUserEvenetResults").html(
								'<p class="failureMessage">Failure:'
										+ errMsg.toString() + '</p>');
						$("#nbUserEvenetResults")
								.addClass("alert alert-danger");
					}
				});

	}

	$(document).ready(function() {
		$("#txtFromDate").datepicker({
			numberOfMonths : 1,
			dateFormat : 'dd/mm/yy',
			onSelect : function(selected) {
				$("#txtToDate").datepicker("option", "minDate", selected)
			}
		}).keyup(function(e) {
			if (e.keyCode == 8 || e.keyCode == 46) {
				$.datepicker._clearDate(this);
			}
		});
		$("#txtToDate").datepicker({

			numberOfMonths : 1,
			dateFormat : 'dd/mm/yy',
			onSelect : function(selected) {
				$("#txtFromDate").datepicker("option", "maxDate", selected)
			}
		}).keyup(function(e) {
			if (e.keyCode == 8 || e.keyCode == 46) {
				$.datepicker._clearDate(this);
			}
		});

	});

	function getNBEventDates() {
		$("#nbEventsDates").attr("style", "margin: -4% 0 1%;");
		$("#fetchNBUserEvents").attr("style", "margin: 8% 0 0;");
		updateTime();
		destroyDataTable('fetchNBUserEventsData');
		var fromDate = $("#txtFromDate").val();
		var toDate = $("#txtToDate").val();
		$
				.ajax({
					type : "GET",
					contentType : "application/json; charset=utf-8",
					url : "/MonitoringRestServices/rest/nightlyBatchEvents/"
							+ loggedUserID + "?startDate=" + fromDate
							+ "&endDate=" + toDate + "&mtime=" + mTime,
					dataType : "json",
					headers : getHeadersData(),
					success : function(responseData) {
						console.log("Nightly Batch  Events Success.. ");
						$("#fetchNBUserEventsData tbody").html("");
						$("#fetchNBUserEvents").show();
						if (responseData.length > 0) {
							$(".my-legend").show();
							$("#nbUserEvenetResults").html("");
							$("#nbUserEvenetResults").removeClass(
									"alert alert-danger");
							$("#nbEventsDates").attr("style",
									"margin: 0% 0 -3%;");
							$("#fetchNBUserEvents").attr("style",
									"margin: 4% 0 0;");
							$("#fetchNBUserEventsData").attr("style",
									"width:100%;");
							var nbErrorColor = null;
							var nbErrorTxtColor = 'white';
							$
									.each(
											responseData,
											function(i, item) {
												if (item.errorLevel == 4) {
													nbErrorColor = 'red';
												} else if (item.errorLevel == 3) {
													nbErrorColor = 'Orange';
												} else if (item.errorLevel == 1) {
													nbErrorColor = 'green';
												} else if (item.errorLevel == 0) {
													nbErrorColor = 'green';
												}
												$("#fetchNBUserEventsData tbody")
														.append(
																'<tr style="background:'+nbErrorColor+';color:'+nbErrorTxtColor+'"><td class="nbErrorMessage">'
																		+ item.errorMessage
																		+ '</td>'
																		+ '<td class="nbEParameters" style="display:none;">'
																		+ item.parameters
																		+ '</td>'
																		+ '<td id="nbEventDescription">'
																		+ item.description
																		+ '</td>'
																		+ '<td id="nbEIDate">'
																		+ item.insertedDate
																		+ '</td>'
																		+ '<td id="nbEventHost">'
																		+ item.host
																		+ '</td>'
																	    +'<td id="nbErrorLevel" style="display:none;">'
																		+ item.errorLevel
																		+ '</td></tr>'); 
											});
							$('#fetchNBUserEventsData').dataTable({
								"searching" : true,
								"destroy" : true,
								"language" : {
									search : "_INPUT_",
									searchPlaceholder : "Search..."
								},
								"pagingType" : "simple",
								"bLengthChange" : false,
								"bSort" : true
							});
						} else {
							$(".my-legend").hide();
							$("#nbEventsDates").attr("style",
									"margin: -4% 0 1%;");
							$("#fetchNBUserEvents").attr("style",
									"margin: 8% 0 0;");
							$("#nbUserEvenetResults")
									.html(
											'<p class="failureMessage">No Events are avaialble</p>');
							$("#nbUserEvenetResults").addClass(
									"alert alert-danger");
						}
						$('input, search').placeholder();
					},
					failure : function(errMsg) {
						$("#fetchNBUserEvents")
								.attr("style", "margin: 8% 0 0;");
						$("#nbUserEvenetResults").html(
								'<p class="failureMessage">Failure:'
										+ errMsg.toString() + '</p>');
						$("#nbUserEvenetResults")
								.addClass("alert alert-danger");
						$(".my-legend").hide();
					}
				});

	}
</script>
<h2>Nightly Batch Events</h2>
<div class="" id="fetchNBUserEvents">
	<div id="nbEventsDates" style="display: none;">
		<div id="refresh-btn">
			<table>
				<tr>
					<td><input type="button" onclick="getNBUSerEventList();"
						class="btn btn-primary today " value="Today" /></td>
					<td class="refresh"><input type="button"
						onclick="getNBUSerEventList();" class="btn btn-primary "
						value="Refresh" /></td>
				</tr>
			</table>
		</div>

		<table class="nbUserDatePicker">
			<tr>
				<td><input type="text" id="txtFromDate" placeholder="From"
					class="form-control" name="txtStartDate" /></td>
				<td><input type="text" id="txtToDate" placeholder="To"
					class="form-control" /></td>
				<td><input type="button" onclick="getNBEventDates();"
					class="btn btn-info " value="GO" /></td>
			</tr>
		</table>
	</div>

	<div class="nbUserEventData">
		<table id="fetchNBUserEventsData" border="1" class="table">
			<thead>
				<tr>
					<td>Error Message</td>
					<td style="display: none;">Parameters</td>
					<td>Description</td>
					<td>Inserted Date</td>
					<td>Host Name</td>
					<td style="display: none;">Error Level</td>
				</tr>
			</thead>
			<tbody></tbody>
		</table>
	</div>
</div>
<div class='my-legend' style="display: none;">
	<div class='legend-scale'>
		<ul class='legend-labels'>
			<li><span style="background-color: green;"></span>Good</li>
			<li><span style="background-color: orange;"></span>Warning</li>
			<li><span style="background-color: red;"></span>Risk</li>
		</ul>
	</div>
</div>

<div id="nbUserEvenetResults"></div>